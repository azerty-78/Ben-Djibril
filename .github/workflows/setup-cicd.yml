name: üöÄ Frontend CI/CD

# ==========================================
# D√âCLENCHEMENT
# ==========================================
# Ce workflow se d√©clenche :
# - Automatiquement sur push vers main ou master
# - Automatiquement sur pull_request vers main ou master
# - Manuellement depuis l'onglet Actions (workflow_dispatch)
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # Permet de d√©clencher manuellement depuis GitHub

# ==========================================
# VARIABLES GLOBALES
# ==========================================
env:
  DOCKER_IMAGE: azerty78/blogpress-frontend
  DOCKERFILE_PATH: setup-front/Dockerfile
  DOCKER_CONTEXT: .

# ==========================================
# JOBS
# ==========================================
jobs:
  # ==========================================
  # JOB 1: Create Git Tags
  # ==========================================
  tags:
    name: üè∑Ô∏è Create Git Tags
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üìã Tag Info
        run: |
          echo "‚úÖ Informations sur les tags Git"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          
          # Afficher les tags existants
          git tag -l | head -10 || echo "Aucun tag trouv√©"
          
          # Si c'est un push sur main ou master, afficher les informations
          if [ "${{ github.ref }}" == "refs/heads/master" ] || [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "üìå Push sur ${{ github.ref_name }} d√©tect√©"
            echo "Commit: ${{ github.sha }}"
            echo "Message: $(git log -1 --pretty=%B)"
          fi
  
  # ==========================================
  # JOB 2: Build Docker Image
  # ==========================================
  build:
    needs: tags
    name: üî® Build & Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # √âtape 1: Checkout du code
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      # √âtape 2: Setup Docker Buildx
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # √âtape 3: Login √† DockerHub
      - name: üîê Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      
      # √âtape 4: Extract metadata (tags, labels)
      - name: üìã Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      # √âtape 5: Lire les variables depuis le fichier .env
      - name: üìÑ Read .env file
        id: env_vars
        run: |
          # V√©rifier que le fichier .env existe
          if [ ! -f "setup-front/.env" ]; then
            echo "‚ùå Erreur: Le fichier setup-front/.env n'existe pas"
            echo "üí° Assurez-vous que le fichier setup-front/.env est pr√©sent dans le repository"
            exit 1
          fi
          
          echo "‚úÖ Fichier setup-front/.env trouv√©"
          
          # Extraire les variables EmailJS depuis le fichier .env
          # Utiliser grep pour trouver les lignes et cut pour extraire les valeurs (apr√®s le =)
          # Supprimer les guillemets et espaces
          VITE_EMAILJS_PUBLIC_KEY=$(grep "^VITE_EMAILJS_PUBLIC_KEY=" setup-front/.env | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed "s/^['\"]//;s/['\"]$//" || echo "")
          VITE_EMAILJS_SERVICE_ID=$(grep "^VITE_EMAILJS_SERVICE_ID=" setup-front/.env | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed "s/^['\"]//;s/['\"]$//" || echo "")
          VITE_EMAILJS_CONTACT_TEMPLATE_ID=$(grep "^VITE_EMAILJS_CONTACT_TEMPLATE_ID=" setup-front/.env | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed "s/^['\"]//;s/['\"]$//" || echo "")
          VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID=$(grep "^VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID=" setup-front/.env | cut -d '=' -f2- | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed "s/^['\"]//;s/['\"]$//" || echo "")
          
          # V√©rifier que les variables ne sont pas vides
          MISSING_VARS=0
          if [ -z "$VITE_EMAILJS_PUBLIC_KEY" ]; then
            echo "‚ùå VITE_EMAILJS_PUBLIC_KEY est vide ou manquant"
            MISSING_VARS=1
          else
            echo "‚úÖ VITE_EMAILJS_PUBLIC_KEY: ${VITE_EMAILJS_PUBLIC_KEY:0:10}... (masqu√©)"
          fi
          
          if [ -z "$VITE_EMAILJS_SERVICE_ID" ]; then
            echo "‚ùå VITE_EMAILJS_SERVICE_ID est vide ou manquant"
            MISSING_VARS=1
          else
            echo "‚úÖ VITE_EMAILJS_SERVICE_ID: ${VITE_EMAILJS_SERVICE_ID:0:10}... (masqu√©)"
          fi
          
          if [ -z "$VITE_EMAILJS_CONTACT_TEMPLATE_ID" ]; then
            echo "‚ùå VITE_EMAILJS_CONTACT_TEMPLATE_ID est vide ou manquant"
            MISSING_VARS=1
          else
            echo "‚úÖ VITE_EMAILJS_CONTACT_TEMPLATE_ID: ${VITE_EMAILJS_CONTACT_TEMPLATE_ID:0:10}... (masqu√©)"
          fi
          
          if [ -z "$VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID" ]; then
            echo "‚ùå VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID est vide ou manquant"
            MISSING_VARS=1
          else
            echo "‚úÖ VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID: ${VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID:0:10}... (masqu√©)"
          fi
          
          if [ "$MISSING_VARS" -eq 1 ]; then
            echo "‚ùå Erreur: Certaines variables EmailJS sont manquantes dans setup-front/.env"
            echo "üí° V√©rifiez que toutes les variables EmailJS sont d√©finies dans le fichier .env"
            exit 1
          fi
          
          echo "‚úÖ Toutes les variables EmailJS ont √©t√© extraites avec succ√®s du fichier .env"
          
          # Sauvegarder dans des variables d'environnement pour les √©tapes suivantes
          echo "VITE_EMAILJS_PUBLIC_KEY=$VITE_EMAILJS_PUBLIC_KEY" >> $GITHUB_ENV
          echo "VITE_EMAILJS_SERVICE_ID=$VITE_EMAILJS_SERVICE_ID" >> $GITHUB_ENV
          echo "VITE_EMAILJS_CONTACT_TEMPLATE_ID=$VITE_EMAILJS_CONTACT_TEMPLATE_ID" >> $GITHUB_ENV
          echo "VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID=$VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID" >> $GITHUB_ENV
      
      # √âtape 6: Build & Push Docker Image
      - name: üî® Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.DOCKER_CONTEXT }}
          file: ${{ env.DOCKERFILE_PATH }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            VITE_EMAILJS_PUBLIC_KEY=${{ env.VITE_EMAILJS_PUBLIC_KEY }}
            VITE_EMAILJS_SERVICE_ID=${{ env.VITE_EMAILJS_SERVICE_ID }}
            VITE_EMAILJS_CONTACT_TEMPLATE_ID=${{ env.VITE_EMAILJS_CONTACT_TEMPLATE_ID }}
            VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID=${{ env.VITE_EMAILJS_NEWSLETTER_TEMPLATE_ID }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max
          pull: true
      
      # √âtape 7: Afficher les informations de l'image
      - name: üìä Image Info
        if: success()
        run: |
          echo "‚úÖ Image build√©e avec succ√®s!"
          echo "üì¶ Image: ${{ env.DOCKER_IMAGE }}"
          echo "üè∑Ô∏è  Tags: ${{ steps.meta.outputs.tags }}"
          docker images | grep "${{ env.DOCKER_IMAGE }}"
  
  # ==========================================
  # JOB 3: Test Docker Image (optionnel pour l'instant)
  # ==========================================
  test:
    name: üß™ Test Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'  # Skip tests sur PR
    
    steps:
      # √âtape 1: Checkout
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      # √âtape 2: Setup Docker Buildx
      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # √âtape 3: Login √† DockerHub
      - name: üîê Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      
      # √âtape 4: Pull l'image build√©e
      - name: üê≥ Pull Docker Image
        run: |
          docker pull ${{ env.DOCKER_IMAGE }}:latest || echo "Image not found, will build locally"
      
      # √âtape 5: Test basique (v√©rifier que le conteneur d√©marre)
      - name: ‚úÖ Test Container Start
        run: |
          docker run -d --name test-container -p 8080:80 ${{ env.DOCKER_IMAGE }}:latest || docker run -d --name test-container -p 8080:80 ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          sleep 5
          curl -f http://localhost:8080/health || curl -f http://localhost:8080 || exit 1
          echo "‚úÖ Container started successfully!"
          docker stop test-container
          docker rm test-container
